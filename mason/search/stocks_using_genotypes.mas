<%args>


</%args>

<& /util/import_javascript.mas, classes => [ 'jquery', 'jquery.dataTables' ] &>

<& /page/page_title.mas, title=>'Search Accessions with Specific Genotype' &>

<&| /page/info_section.mas, title=>'Step 1: Select a set of accessiions (dataset)'&>
    <div class="row" id="search_form_1" >
        <div class="col-sm-1">
        </div>
        <div class="col-sm-12 well">
            <span style="width:240px" id="dataset_accessions"></span>
        </div>
    </div>
</&>
<br>
<&| /page/info_section.mas, title=>'Step 2: Select a set of marker info (marker set)'&>
    <div class="row" id="search_form_2" >
        <div class="col-sm-1">
        </div>
        <div class="col-sm-12 well">
            <div class="row">
                <div class="col-sm-11">
                    <div class="form-horizontal">
                        <div class="form-group">
                            <label class="control-label col-sm-4">Select a set of markers (marker set):</label>
                            <div class="col-sm-8" >
                                <div class="input-group">
                                    <select class="form-control" id="markerset_select">
                                        <option value="">Select a marker set</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</&>
<br>
<&| /page/info_section.mas, title=>'Step 3: Search options'&>
    <div class="row" id="search_form_3" >
        <div class="col-sm-1">
        </div>
        <div class="col-sm-12 well">
            <div class="row">
                <div class="col-sm-11">
                    <div class="form-horizontal">
                        <div class="form-group">
                            <label class="control-label col-sm-4"></label>
                            <div class="col-sm-8" >
                                <button class="btn btn-info" id="search_accessions_using_dosages"><i class="glyphicon glyphicon-search"></i> Search by Using Dosages</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-sm-4"></label>
                            <div class="col-sm-8" >
                                <button class="btn btn-info" id="search_accessions_using_snps"><i class="glyphicon glyphicon-search"></i> Search by Using SNPs</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
 </&>


<&| /page/info_section.mas, title => 'Search Results' , collapsible=>1, collapsed=>0 &>

    <link rel="stylesheet" type="text/css" href="/documents/inc/datatables/jquery.dataTables.css">

    <table id="genotype_search_results" width="100%" class="table table-hover table-striped">
    </table>
</&>

<script>


jQuery(document).ready(function (){

    var data_set = new CXGN.Dataset();
    var lo = new CXGN.List();

    get_select_box('datasets', 'dataset_accessions', {"checkbox_name":"dataset_accessions_checkbox"});

    jQuery('#markerset_select').html(lo.listSelect('markerset_select', ['markers'], 'Select a marker set', undefined, undefined));

    jQuery("#search_accessions_using_dosages").click(function(){

        var selected_datasets = [];
        var dataset_id;
        jQuery('input[name="dataset_accessions_checkbox"]:checked').each(function() {
            selected_datasets.push(jQuery(this).val());
        });

        if (selected_datasets.length < 1){
            alert('Please select a set of accessions!');
            return false;
        } else if (selected_datasets.length > 1){
            alert('Please select only one set of accessions!');
            return false;
        } else {
            dataset_id = selected_datasets[0];
        }

        var markerset_id = jQuery('#markerset_select').val();

        var table = jQuery('#genotype_search_results').DataTable({
            'destroy' : true,
            'ajax': { 'url':'/ajax/search/accessions_using_dosages',
                'data':{
                    'dataset_id': dataset_id,
                    'markerset_id': markerset_id,
                }
            },
            columns: [
                {
                    title: "Accessions",
                    data: null,
                    render: function(data, type, row){return "<a href='/stock/"+row.stock_id+"/view'>"+row.stock_name+"</a>";}},
                {
                    title: "Genotypes",
                    data: "genotypes",
                    render: function(data, type,row){
                        var newFormat = data.split(",").join("&nbsp &nbsp &nbsp &nbsp &nbsp");
                        return newFormat;
                    }
                },
            ],
        });
    });

    jQuery("#search_accessions_using_snps").click(function(){

        var selected_datasets = [];
        var dataset_id;
        jQuery('input[name="dataset_accessions_checkbox"]:checked').each(function() {
            selected_datasets.push(jQuery(this).val());
        });

        if (selected_datasets.length < 1){
            alert('Please select a set of accessions!');
            return false;
        } else if (selected_datasets.length > 1){
            alert('Please select only one set of accessions!');
            return false;
        } else {
            dataset_id = selected_datasets[0];
        }

        var markerset_id = jQuery('#markerset_select').val();

        var table = jQuery('#genotype_search_results').DataTable({
            'destroy' : true,
            'ajax': { 'url':'/ajax/search/accessions_using_snps',
                'data':{
                    'dataset_id': dataset_id,
                    'markerset_id': markerset_id,
                }
            },
            columns: [
                {
                    title: "Accessions",
                    data: null,
                    render: function(data, type, row){return "<a href='/stock/"+row.stock_id+"/view'>"+row.stock_name+"</a>";}},
                {
                    title: "Genotypes",
                    data: "genotypes",
//                    render: function(data, type,row){
//                        var newFormat = data.split(",").join("&nbsp &nbsp &nbsp &nbsp &nbsp");
//                        return newFormat;
//                    }
                },
            ],
        });
    });
});


</script>
